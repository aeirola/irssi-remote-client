<polymer-element name="settings-element" extends="window-aware-element">
  <template>
    <form role="form" on-submit="{{save}}">
      <div class="form-group">
        <label for="url">Url</label>
        <input id="url" class="form-control" type="url" value="{{url}}" placeholder="https://host:port/path">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" class="form-control" type="password" placeholder="password">
      </div>
      <div class="form-group">
        <label for="poll-length">Poll-length</label>
        <input id="poll-length" type="range" min="1" max="3600" value="{{pollLength}}"> {{pollLength}}
      </div>
      <button class="btn btn-default">Save</button>
    </form>

    <polymer-localstorage autoSaveDisabled id="urlStore" name="irssi-remote-client-url" value="{{url}}"></polymer-localstorage>
    <polymer-localstorage autoSaveDisabled id="passwordStore" name="irssi-remote-client-password" value="{{password}}"></polymer-localstorage>
    <polymer-localstorage autoSaveDisabled id="pollLengthStore" name="irssi-remote-client-pollLength" value="{{pollLength}}"></polymer-localstorage>
  </template>
  <script>
    Polymer('settings-element', {
      url: '',
      password: '',
      pollLength: 300,
      ready: function ready(e) {
        this.addEventListener('polymer-localstorage-load', this.notify);
      },
      notify: function notify(event) {
        var settings = {
          url: this.url,
          password: this.password,
          pollLength: this.pollLength
        };
        this.fire('polymer-signal', {name: 'settings-changed', data: settings});
      },
      save: function save(event) {
        event.preventDefault();

        // Hash password
        if (this.$.password.value) {
          this.password = CryptoJS.SHA512(this.$.password.value).toString(CryptoJS.enc.Base64).replace(/=*/g, '');
        }

        // Store settings
        this.$.urlStore.save();
        this.$.passwordStore.save();
        this.$.pollLengthStore.save();

        // Notify watchers
        this.notify();
      }
    });
  </script>
</polymer-element>
