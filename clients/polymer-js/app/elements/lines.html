<polymer-element name="lines-element" extends="window-aware-element">
  <template>
    <style>
      :host {
        display: block;
        overflow-x: scroll;
      }
      p {
        font-family: monospace;
        margin: 0;
        padding: 0;
      }
    </style>

    <template repeat="{{line in lines}}">
      <p>{{line.text}}</p>
    </template>

    <json-rpc-element id="initialLoad" auto url="https://aie.kapsi.fi/irc/json-rpc"
        method="getWindowLines"
        params='{"refnum": {{refnum}}, "rowLimit": {{rowLimit}}}'
        response="{{lines}}"
        headers='{"Irssi-Authorization": "8AZxhrn7iuVRGKSDKHIZkUZ9cwUpKNZQoEOch4cQkq36s5BLs6EGv83bS1ItwGufvqbCmDasj/Uzeuwlm8ca5A"}'
        on-polymer-response="{{linesLoaded}}">
    </json-rpc-element>
    <json-rpc-element id="longPolling" url="https://aie.kapsi.fi/irc/json-rpc"
      method="getWindowLines"
      params='{"refnum": {{refnum}}, "timestampLimit": {{lastTimestamp}}, "timeout": 300}'
      headers='{"Irssi-Authorization": "8AZxhrn7iuVRGKSDKHIZkUZ9cwUpKNZQoEOch4cQkq36s5BLs6EGv83bS1ItwGufvqbCmDasj/Uzeuwlm8ca5A"}'
      on-polymer-response="{{newLineLoaded}}">
    </json-rpc-element>
  </template>
  <script>
    Polymer('lines-element', {
      lines: [],
      rowLimit: 100,
      lastTimestamp: 0,
      pollRequest: null,
      linesLoaded: function linesLoaded(_, data) {
        var lines = data.response;
        if (lines.length > 0) {
          var lastLine = lines[lines.length-1];
          this.lastTimestamp = lastLine.timestamp;
        }
        this.lines = lines;

        if (this.pollRequest) {
          this.pollRequest.abort();
        }

        this.async(function() {
          this.pollRequest = this.$.longPolling.go();
          this.scrollTop = this.scrollHeight;
        });
      },
      newLineLoaded: function newLineLoaded(_, data) {
        if (data.xhr.status != 200) {
          // Error
          return;
        }
        var lines = data.response;

        if (lines.length > 0) {
          var lastLine = lines[lines.length-1];
          this.lastTimestamp = lastLine.timestamp;
          this.lines = this.lines.concat(lines);
        }

        this.async(function() {
          this.pollRequest = this.$.longPolling.go();
          this.scrollTop = this.scrollHeight;
        });
      }
    });
    </script>
</polymer-element>
